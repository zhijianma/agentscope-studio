name: Docker Build and Push

on:
    release:
        types: [published]

env:
    REGISTRY: docker.io
    IMAGE_NAME: zhijianma/studio

jobs:
    build-push:
        runs-on: ubuntu-latest
        timeout-minutes: 40

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Install docker-compose
              run: |
                  echo "ğŸ“¦ Installing docker-compose..."
                  sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64" -o /usr/local/bin/docker-compose
                  sudo chmod +x /usr/local/bin/docker-compose
                  docker-compose --version

            - name: Setup docker.sh
              run: chmod +x docker/docker.sh

            - name: Get version from package.json
              id: package_version
              run: |
                  PACKAGE_VERSION=$(node -p "require('./package.json').version")
                  TAG="v${PACKAGE_VERSION}"
                  echo "version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
                  echo "tag=$TAG" >> $GITHUB_OUTPUT
                  echo "ğŸ“¦ Package.json version: $PACKAGE_VERSION"
                  echo "ğŸ·ï¸  Docker tag: $TAG"

            - name: Get version from Release tag
              id: release_version
              run: |
                  RELEASE_VERSION=${GITHUB_REF#refs/tags/v}
                  echo "version=$RELEASE_VERSION" >> $GITHUB_OUTPUT
                  echo "ğŸ·ï¸  Release tag version: $RELEASE_VERSION"

            - name: Verify version consistency
              run: |
                  PACKAGE_V="${{ steps.package_version.outputs.version }}"
                  RELEASE_V="${{ steps.release_version.outputs.version }}"
                  if [ "$PACKAGE_V" != "$RELEASE_V" ]; then
                    echo "::error::âŒ Version mismatch! package.json: $PACKAGE_V, tag: $RELEASE_V"
                    exit 1
                  fi
                  echo "âœ… Version match: $PACKAGE_V"

            - name: Build Docker image (docker.sh build)
              run: |
                  echo "ğŸ”¨ Building Docker image..."
                  ./docker/docker.sh build
                  docker tag agentscope/studio:latest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.package_version.outputs.tag }}
                  docker tag agentscope/studio:latest ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
                  docker images

            - name: Update docker-compose image
              run: |
                  sed -i "s|image: agentscope/studio:latest|image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest|g" docker/docker-compose.yml

            - name: Start container (docker.sh start)
              run: |
                  echo "ğŸš€ Starting container..."
                  ./docker/docker.sh start
                  sleep 10

            - name: Check status (docker.sh status)
              run: ./docker/docker.sh status

            - name: Health check
              run: |
                  echo "ğŸ¥ Health check..."
                  for i in {1..30}; do
                    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/trpc 2>/dev/null || echo "000")
                    if [ "$HTTP_CODE" != "000" ]; then
                      echo "âœ… Service responding (HTTP $HTTP_CODE)"
                      exit 0
                    fi
                    echo "Waiting... ($i/30)"
                    sleep 2
                  done
                  echo "âŒ Service not responding"
                  exit 1

            - name: Print container logs
              if: always()
              run: |
                  echo "ğŸ“‹ Container logs:"
                  docker-compose -f docker/docker-compose.yml logs --tail=100 || true

            - name: Stop container (docker.sh stop)
              if: always()
              run: ./docker/docker.sh stop

            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_TOKEN }}

            - name: Push to Docker Hub
              run: |
                  TAG=${{ steps.package_version.outputs.tag }}
                  echo "ğŸš€ Pushing ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}..."
                  docker push "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${TAG}"
                  docker push "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"

            - name: Success
              run: |
                  TAG=${{ steps.package_version.outputs.tag }}
                  echo ""
                  echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
                  echo "â•‘  ğŸ‰  DOCKER PUSH SUCCESS                                    â•‘"
                  echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
                  echo "â•‘  Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}"
                  echo "â•‘  Tag:   ${TAG}"
                  echo "â•‘  URL:   https://hub.docker.com/r/${{ env.IMAGE_NAME }}"
                  echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
                  echo ""
